<!-- Button to trigger modal -->

<a id="buyButton" class="btn">Buy</a>
<a id="rentButton" class="btn">Rent</a>

<script>
    //Execute immediately
    (function () {
        var container, success, error, buyModal, rentModal, noCreditsModal;
        container =$('#container');
        success = $(
                "<div class='alert alert-success'>\
                    <button type='button' class='close' data-dismiss='alert'>&times</button>\
                    <strong>Purchase completed!</strong> The purchase was succesfull. Go watch the movie here: LINK?\
                </div>");
        error = $(
                "<div class='alert alert-error'>\
                    <button type='button' class='close' data-dismiss='alert'>&times</button>\
                    <strong>Error!</strong> An error occurred. Please try again.\
                </div>");
        buyModal = $(
                "<div id='buyModal' class='modal hide'> <div class='modal-header'>\
                    <button type='button' class='close' data-dismiss='modal'>&times</button>\
                    <div id='buyModalHeader'/><h3>Are you sure?</h3></div>\
                    <div id='buyModalBody' class='modal-body'><p>Do you really want to buy this movie?!</p></div>\
                    <div class='modal-footer'>\
                        <button id='buyModalCancelButton' class='btn' data-dismiss='modal'>Cancel</button>\
                        <button id='buyModalActionButton' class='btn btn-primary'>Buy</button>\
                    </div>\
                </div>");
        rentModal = $(
                "<div id='rentModal' class='modal hide'> <div class='modal-header'>\
                    <button type='button' class='close' data-dismiss='modal'>&times</button>\
                    <div id='rentModalHeader'/><h3>Are you sure?</h3></div>\
                    <div id='rentModalBody' class='modal-body'><p>Do you really want to rent this movie?!</p></div>\
                    <div class='modal-footer'>\
                        <button id='rentModalCancelButton' class='btn' data-dismiss='modal'>Cancel</button>\
                        <button id='rentModalActionButton' class='btn btn-primary'>Rent</button>\
                    </div>\
                </div>");

        noCreditsModal = $(
                "<div id='noCreditsModal' class='modal hide'> <div class='modal-header'>\
                    <button type='button' class='close' data-dismiss='modal'>&times</button>\
                    <div id='noCreditsModalHeader'/><h3>Not enough credits</h3></div>\
                    <div id='noCreditsModalBody' class='modal-#container'><p>You don't seem to have enough credits. Link to credits site and stuff.</p></div>\
                    <div class='modal-footer'>\
                        <button id='noCreditsModalCancelButton' class='btn' data-dismiss='modal'>Cancel</button>\
                    </div>\
                </div>");

        $('#buyButton').click(function () {
            //TODO: Get actual user id and credits for current item
            validateUserBalance(1, 1000, showBuyModal)
        });

        $('#rentButton').click(function () {
            //TODO: Get actual user id and credits for current item
            validateUserBalance(1, 300, showRentModal)
        });

        buyModal.find("#buyModalActionButton").click(function() {
            var postData = JSON.stringify({ userId: 1});
            $.ajax({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/1/purchase',
                type: 'POST',
                data: postData,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: true,
                success: function(msg) {
                    error.remove();
                    container.prepend(success);
                },
                error: function(msg) {
                    success.remove();
                    container.prepend(error);
                }
            });
            buyModal.modal('hide');
        });

        rentModal.find("#rentModalActionButton").click(function() {
            var postData = JSON.stringify({ userId: 1});
            $.ajax({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/1/rent',
                type: 'POST',
                data: postData,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: true,
                success: function(msg) {
                    error.remove();
                    container.prepend(success);
                },
                error: function(msg) {
                    success.remove();
                    container.prepend(error);
                }
            });
            rentModal.modal('hide');
        });

        function validateUserBalance(userId, creditsNeeded, func) {
            $.getJSON("http://rentit.itu.dk/RentIt25/moofy.svc/users/" + userId, function (user) {
                if (user.balance >= creditsNeeded) {
                    func();
                } else {
                    showNoCreditsModal();
                }
            });
        }

        function showNoCreditsModal() {
            container.append(noCreditsModal);
            //Show the modal dialog
            noCreditsModal.modal(null);
        }

        function showBuyModal() {
            container.append(buyModal);
            //Show the modal dialog
            buyModal.modal(null);
        }

        function showRentModal() {
            //Perform first time setup
            container.append(rentModal);
            //Show the modal dialog
            rentModal.modal(null);
        }
    })();

</script>