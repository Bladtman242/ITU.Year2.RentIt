<!-- Button to trigger modal -->

<a id="buyButton" class="btn">Buy</a>
<a id="rentButton" class="btn">Rent</a>

<script>
    //Execute immediately
    (function () {
        $('#buyButton').click(function () {
            //TODO: Get actual user id and credits for current item
            var onBuyClick = function() {
                var postData = JSON.stringify({ userId: framework.user.id});
                $.ajax({
                    url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/1/purchase',
                    type: 'POST',
                    data: postData,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: true,
                    success: function(msg) {
                        output.success('Success!', 'The item was bought.');
                    },
                    error: function(msg) {
                        output.error('Error!', 'An error occured. Please try again.');
                    }
                });
            };
            var callAfterValidation = function() {
                output.modal('Are you sure?', 'Do you really want to buy this movie?', 'Buy', onBuyClick);
            };
            validateUserBalance(framework.user.id, 1000, callAfterValidation);
        });

        $('#rentButton').click(function () {
            //TODO: Get actual user id and credits for current item
            var onRentClick = function() {
                var postData = JSON.stringify({ userId: framework.user.id});
                $.ajax({
                    url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/1/rent',
                    type: 'POST',
                    data: postData,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: true,
                    success: function(msg) {
                        output.success('Success!', 'The item was rented.');
                    },
                    error: function(msg) {
                        output.error('Error!', 'An error occured. Please try again.');
                    }
                });
            };
            var callAfterValidation = function() {
                output.modal('Are you sure?', 'Do you really want to rent this movie?', 'Rent', onRentClick);
            };
            validateUserBalance(framework.user.id, 300, callAfterValidation)
        });



        function validateUserBalance(userId, creditsNeeded, func) {
            $.getJSON("http://rentit.itu.dk/RentIt25/moofy.svc/users/" + userId, function (user) {
                if (user.balance >= creditsNeeded) {
                    func();
                } else {
                    output.modal('Not enough credits', "You don't seem to have enough credits. Link to account site or something.");
                }
            });
        }
    })();

</script>