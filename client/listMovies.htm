<h3>Highest Rated Movies</h3>	
<div class="carousel slide span12" id="carousel">
<div class="carousel-inner" id="innerCar">
</div>
<a class="carousel-control left" href="#carousel" data-slide="prev">&lsaquo;</a>
<a class="carousel-control right" href="#carousel" data-slide="next">&rsaquo;</a>
</div>
<div >
	
	<form class="form-search" id="searchForm">
		<input id="searchInput" type="text" class="input-medium search-query">
		<button id="searchSubmit" type="submit" class="btn btn-primary">Search</button>
	</form>
</div>
<div class="container">  
      <ul class="thumbnails" id="thumbs">
	  </ul>  
<hr>  
</div>
<div class="pagination" id="paginDiv">
		<ul id="pagin" >
		</ul>
</div>
<script>
var curCont, curPage, pages;
var thumbs = $("#thumbs");

$("#innerCar").append(initMovPage);
createThumbContent(curCont);
setPage(1);
$('#carousel').carousel({
        interval: 4500
    });

$('#carousel').carousel('cycle');
function initMovPage()
{
    var s= "";
	 $.ajax({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/filter',
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                success: function(movs) {
					curCont = movs;
					movs.sort(function(a,b){return b.avgRating - a.avgRating})
					s=createMoviesCarousel(movs);					
                },
                error: function(msg) {
                    output.error("Error!","failed to connect to server, please try again");
                }
            });

	return s;
}
function createMoviesCarousel(movs)
{
		var length = movs.length;
		var s = "";
		if(length == 0) return;
		var rest = length<9 ? length % 3 : 0;					
		s+="<div class='item active'>\
				<ul class='thumbnails'>\
					<li class='span4'>\
						<div class='thumbnail'>\
							<a class='internal' href='?movieId="+movs[0].id+"#movie'><img class='carouselElem' src='"+movs[0].coverUri+"' alt='' border='0'/></a>\
						</div>\
					</li>";	
		for (var i=1; i<9 && i<length - rest; i++)
		{ 
			if(i%3 == 0)
			{
				s += "<div class='item'>\
						<ul class='thumbnails'>\
							<li class='span4'>\
								<div class='thumbnail'>\
									<a class='internal' href='?movieId="+movs[i].id+"#movie'><img class='carouselElem' src='"+movs[i].coverUri+"' alt='' border='0'/></a>\
								</div>\
							</li>";	
			}
			if(i%3 == 1)
			{
				s+= "<li class='span4'>\
							<div class='thumbnail'>\
								<a class='internal' href='?movieId="+movs[i].id+"#movie'><img class='carouselElem' src='"+movs[i].coverUri+"' alt='' border='0'/></a>\
							</div>\
					</li>";
			}
			if(i%3 == 2)
			{
				s+=		   "<li class='span4'>\
								<div class='thumbnail'>\
									<a class='internal' href='?movieId="+movs[i].id+"#movie'><img class='carouselElem' src='"+movs[i].coverUri+"' alt='' border='0'/></a>\
								</div>\
							</li>\
						</ul>\
					</div>";
			}
			}
			if(rest == 1)
			{
				s += "<div class='item'>\
						<ul class='thumbnails'>\
							<li class='span4'>\
								<div class='thumbnail'>\
									<a class='internal' href='?movieId="+movs[length-1].id+"#movie'><img class='carouselElem' src='"+movs[length-1].coverUri+"' alt='' border='0'/></a>\
								</div>\
							</li>\
						</ul>\
					</div>";
			}
			else if (rest == 2)
			{
				s += "<div class='item'>\
							<ul class='thumbnails'>\
								<li class='span4'>\
									<div class='thumbnail'>\
										<a class='internal' href='?movieId="+movs[length-2].id+"#movie'><img class='carouselElem' src='"+movs[length-2].coverUri+"' alt='' border='0'/></a>\
									</div>\
								</li>\
								<li class='span4'>\
									<div class='thumbnail'>\
										<a class='internal' href='?movieId="+movs[length-1].id+"#movie'><img class='carouselElem' src='"+movs[length-1].coverUri+"' alt='' border='0'/></a>\
									</div>\
								</li>\
							</ul>\
						</div>";
			}
			return $(s);
}
function createThumbContent(movs)
{	
	var nrOfPages = (movs.length%12)==0 ? movs.length/12: movs.length/12 + 1;
	var pagi = "<li><a href='javascript:prevPage()'>Prev</a></li>";
	var ps = new Array();
	for(var i = 1; i<=nrOfPages; i++)
	{
		pagi += "<li><a href='javascript:setPage("+i+")'>"+i+"</a></li>";
	}
	pagi+="<li><a href='javascript:nextPage()'>Next</a></li>";
	var pagin = $("#pagin");
	pagin.empty();
	pagin.append($(pagi));
	for(var i = 0; i<movs.length; i++)
	{	
		var listString="<li class='span3'><div class='thumbnail'><a class='internal' href='?movieId="+movs[i].id+"#movie'><img class='thumbListElem' src='"+movs[i].coverUri+"' alt='' border='0' title='"+movs[i].title+"' /></a><div class='caption thumbCapt'><h5>"+ movs[i].title+"</h5>Rating:&thinsp;"+movs[i].avgRating+"</div></div></li>";
		if (ps[Math.floor(i/12)]) {
			ps[Math.floor(i/12)]+= listString;
		} 
		else {
			ps[Math.floor(i/12)] = listString;
		}
	}
	pages = ps;
	curPage=1;
}
function nextPage()
{
	thumbs.empty();
	thumbs.append(pages[++curPage] || pages[(curPage = 0)]);
}
function prevPage()
{
	thumbs.empty();
	curPage = curPage-1<0 ? pages.length-1 : curPage-1;
	thumbs.append(pages[curPage]);
}
function setPage(nr)
{
	thumbs.empty();
	curPage = nr-1;
	thumbs.append(pages[curPage]);
}
$("#searchSubmit").click(function() {
	var val = $("#searchInput").val().trim();
	var s = val ? "/"+val : "";
	$.ajax({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/filter'+s,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                success: function(movs) {
					curCont = movs;	
					createThumbContent(curCont);
					setPage(1);
                },
                error: function(msg) {
                    output.error("Error!","failed to connect to server, please try again");
                }
            });
	return false;
});
	
</script>
