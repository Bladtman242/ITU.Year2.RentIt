<script>
var container = $("#container");
var id = framework.query.songId;
var data = getSongJSON(id);
container.append(displaySong());

if(framework.user && framework.user.admin) {
    //Show edit and delete buttons
    $("#container").prepend('<div class="pull-right" style="text-align: right;"><a href="?edit=song&id='+id+'#manager" class="internal btn btn-inverse" style="margin-bottom: 5px;">Edit song</a><br><a href="#" id="delete-song-button" class="btn btn-primary">Delete</a></div>');
    //Delete song click
    $("#delete-song-button").click(function() {
        $.ajax({
            url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + id + '/delete',
            type: 'POST',
            data: JSON.stringify({ managerid: framework.user.id }),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if(data.success) {
                    alert("Deleted song...");
                    framework.loadPage("listSongs");
                }
                else {
                    alert("Failed to delete song - "+data.message);
                }
            },
            error: function(msg) {
                alert("Failed to delete song... (server or connection error)");
            }
        });
    });
}

$('#star').raty({ 
	score: data.avgRating,
	path: 'vendor/raty-2.5.2/lib/img/',
	number: 10,
	click: function(score)
	{
		var postData = {};
		if (framework.user == null)
			output.error('Error!', 'You must be logged in to rate a song');
		else
		{
		postData.userId = framework.user.id;
		postData.rating = score;
	        $.ajax({
	            url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + id + '/rate',
	            type: 'POST',
	            data: JSON.stringify(postData),
	            contentType: 'application/json; charset=utf-8',
	            dataType: 'json',
	            async: true,
	            success: function(msg) {
	                location.reload();
	                output.success('Success!', 'Your rating has been submitted.');
	            },
	            error: function(msg) {
	                output.error('Error!', 'An error occured. Please try again.');
	            }
	        });
		}
	}
	});

	$('#buyButton').click(function () {
	    //TODO: Get actual user id and credits for current item
	    var onBuyClick = function() {
	        var postData = JSON.stringify({ userId: framework.user.id});
	        $.ajax({
	            url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + id + '/purchase',
	            type: 'POST',
	            data: postData,
	            contentType: 'application/json; charset=utf-8',
	            dataType: 'json',
	            async: true,
	            success: function(msg) {
	                output.success('Success!', 'The item was bought.');
	                framework.user.balance -= data.purchasePrice;
	            },
	            error: function(msg) {
	                output.error('Error!', 'An error occured. Please try again.');
	            }
	        });
	    };
	    var callAfterValidation = function() {
	        output.modal('Are you sure?', 'Do you really want to buy this song?', 'Buy', onBuyClick);
	    };
	    validateUserBalance(data.purchasePrice, callAfterValidation);
	});

	$('#rentButton').click(function () {
	    //TODO: Get actual user id and credits for current item
	    var onRentClick = function() {
	        var postData = JSON.stringify({ userId: framework.user.id});
	        $.ajax({
	            url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + id + '/rent',
	            type: 'POST',
	            data: postData,
	            contentType: 'application/json; charset=utf-8',
	            dataType: 'json',
	            async: true,
	            success: function(msg) {
	                output.success('Success!', 'The item was rented.');
	                framework.user.balance -= data.rentalPrice;
	            },
	            error: function(msg) {
	                output.error('Error!', 'An error occured. Please try again.');
	            }
	        });
	    };
	    var callAfterValidation = function() {
	        output.modal('Are you sure?', 'Do you really want to rent this song?', 'Rent', onRentClick);
	    };
	    validateUserBalance(data.rentalPrice, callAfterValidation);
	});

function validateUserBalance(creditsNeeded, func) {
    if (framework.user.balance >= creditsNeeded) {
            func();
        } else {
            output.modal('Not enough credits', "You don't seem to have enough credits. Link to account site or something.");
        }
}

function getSongJSON(id)
{
	var json = "";
	$.ajax
	({
		url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + id,
		type: 'GET',
		dataType: 'json',
		contentType: 'application/json; charset=utf-8',
		async: false,
		success: function(data) 
		{
			json=data;
		},
		error: function(msg)
		{
			alert("Song not found");
		}
	});
    return json;
}

function userSongs(userId)
{
	var json = "";
	$.ajax
	({
		url: 'http://rentit.itu.dk/RentIt25/moofy.svc/users/' + userId + '/songs/current',
		type: 'GET',
		dataType: 'json',
		contentType: 'application/json; charset=utf-8',
		async: false,
		success: function(data) 
		{
			json=data;
		},
		error: function(msg)
		{
			alert("Invalid user");
		}
	});
    return json;
}

function displaySong()
{
	var s = "";
	var votes = " votes";
	var buttons ="<div class='btn-group'>\
					<button id='buyButton' class='btn'>Buy - " + data.purchasePrice + " moneys</button>\
					<button id='rentButton' class='btn'>Rent - " + data.rentalPrice + " moneys</button>\
				  </div>";
	
	// check if user owns movie
	var userOwnsSong = false;
	if (framework.user)
	{
		var songs = userSongs(framework.user.id);
		for (var i = 0; i < songs.length; i++)
		{
			alert(songs[i].id);
			if (songs[i].id == id) userOwnsSong = true;
		}
	}
		
	// decide which buttons to show, depending on whether the user is allowed to watch the movie or not
	if (userOwnsSong)
		buttons = "<a class='internal btn btn-primary' href='?movieId=" + id + "#showMovie'>Listen to Song (lyder mega dumt jo)</a>"

	// create site contents
	if (data.numberOfVotes == 1) votes = " vote";
	s+="<div style='height:400px'>\
		<img src='" + data.coverUri + "' class='pull-left' style='width: 400px; height: 400px; padding: 3px; border: 1px solid #ddd; margin: 10px;'>\
		<div style='padding: 3px; margin: 10px;'><br>\
		<p><font size='6'>" + data.title + "</font></p>\
		<p><font size='4'>" + data.album + " - " + data.artists + "</font></p>\
		<hr>\
		<div id='star' class='pull-right'></div><div class='pull-right' style='padding-right:8px'><b>Your vote:</b></div>\
		<p><b>Rating:</b> " + data.avgRating + " - Based on " + data.numberOfVotes + votes + "</p>\
		<p><b>" + data.genres + "</p>\
		<hr>\
		" + buttons + "\
		</div></div>";
	return s;
}

</script>
