<h1>Manager Overview</h1>

<ul id="manager-navigation" class="nav nav-pills">
    <li class="active">
        <a href="#" id="manager-overview-link">Overview</a>
    </li>
    <li>
        <a href="#" id="manager-upload-movie-link">Create new movie</a>
    </li>
    <li>
        <a href="#" id="manager-upload-song-link">Create new song</a>
    </li>
	<li>
        <a href="#" id="manager-promote-link">Promote/demote users</a>
    </li>
</ul>

<div id="manager-content">
    <!--Nothing-->
</div>

<script>
    var $mng_content = $("#manager-content");
    
    var overview = $('<p>Welcome to the manager overview! I\'ll be your guide.</p>\
        <p>This is where you will be creating new songs and movies.</p>\
        If you wish to edit an existing movie, go to the page for the particular movie and click\
        the "Edit movie" button - same goes for songs.</p>\
        <p>If you wish to promote a user or demote another manager, go to the particular user\'s\
        profile and click the corresponding link.</p>');
    
    var upload_movie = $('<form id="fileForm" class="form-horizontal" enctype="multipart/form-data">\
                <legend>Upload movie file</legend>\
                <div class="control-group">\
                    <label class="control-label" for="inputFile">File</label>\
                    <div class="controls">\
                        <input type="file" id="inputFile" name="file" title="Browse for file to upload" />\
                    </div>\
                </div>\
            </form>\
            <form id="uploadMovie" class="form-horizontal">\
            <legend>Create new movie</legend>\
            <div class="control-group">\
                <label class="control-label" for="inputTitle">Title</label>\
                <div class="controls">\
                    <input type="text" id="inputTitle" placeholder="The Hills Have Nails" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputRelease">Release year</label>\
                <div class="controls">\
                    <input type="number" id="inputRelease" placeholder="2000" min="1000" max="3000" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputGenres">Genres</label>\
                <div class="controls">\
                    <textarea id="inputGenres" placeholder="horror,adventure,thriller" required></textarea>\
                    <span class="help-block">Comma-separated list</span>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputDirectors">Directors</label>\
                <div class="controls">\
                    <textarea id="inputDirectors" placeholder="Quentin Tarantino,J.J. Abrams" required></textarea>\
                    <span class="help-block">Comma-separated list</span>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputRental">Rental price</label>\
                <div class="controls">\
                    <input type="number" id="inputRental" placeholder="2" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputPurchase">Purchase price</label>\
                <div class="controls">\
                    <input type="number" id="inputPurchase" placeholder="2" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputCoverUri">Cover URI</label>\
                <div class="controls">\
                    <input type="url" id="inputCoverUri" placeholder="http://swaggerjagger.com/secretcoveruri.png" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputDescription">Description</label>\
                <div class="controls">\
                    <textarea id="inputDescription" placeholder="Lorem ipsum solor dit amet..." required></textarea>\
                </div>\
            </div>\
            <div class="form-actions">\
                <button id="uploadMovieSubmit" class="btn btn-primary">Create</button>\
            </div>\
        </form>');
    
    var upload_song = $('<form id="fileForm" class="form-horizontal" enctype="multipart/form-data">\
                <legend>Upload song file</legend>\
                <div class="control-group">\
                    <label class="control-label" for="inputFile">File</label>\
                    <div class="controls">\
                        <input type="file" id="inputFile" name="file" title="Browse for file to upload" />\
                    </div>\
                </div>\
            </form>\
            <form id="uploadSong" class="form-horizontal">\
            <legend>Create new song</legend>\
            <div class="control-group">\
                <label class="control-label" for="inputArtist">Artist</label>\
                <div class="controls">\
                    <input type="text" id="inputArtist" placeholder="30 Seconds to Mars" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputTitle">Title</label>\
                <div class="controls">\
                    <input type="text" id="inputTitle" placeholder="The Sky is the Limit" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputAlbum">Album</label>\
                <div class="controls">\
                    <input type="text" id="inputAlbum" placeholder="Music Reboot" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputRelease">Release year</label>\
                <div class="controls">\
                    <input type="number" id="inputRelease" placeholder="2000" min="1000" max="3000" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputGenres">Genres</label>\
                <div class="controls">\
                    <textarea id="inputGenres" placeholder="disco,dance,power-rock" required></textarea>\
                    <span class="help-block">Comma-separated list</span>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputRental">Rental price</label>\
                <div class="controls">\
                    <input type="number" id="inputRental" placeholder="2" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputPurchase">Purchase price</label>\
                <div class="controls">\
                    <input type="number" id="inputPurchase" placeholder="2" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputCoverUri">Cover URI</label>\
                <div class="controls">\
                    <input type="url" id="inputCoverUri" placeholder="http://swaggerjagger.com/secretcoveruri.png" required/>\
                </div>\
            </div>\
            <div class="control-group">\
                <label class="control-label" for="inputDescription">Description</label>\
                <div class="controls">\
                    <textarea id="inputDescription" placeholder="Lorem ipsum solor dit amet..." required></textarea>\
                </div>\
            </div>\
            <div class="form-actions">\
                <button id="uploadSongSubmit" class="btn btn-primary">Create</button>\
            </div>\
        </form>');
   
	var demote_promote = $('<div style="width:100%; height:100%; overflow:scroll;">'+filterUsers("")+'</div>');
    var tmp_id = -1337;
    
    $("#manager-navigation a").click(function(e) {
        e.preventDefault();
        $("#manager-navigation li.active").removeClass("active");
        var $t = $(this);
        $t.parent().addClass("active");
        switch(this.id) {
            case('manager-overview-link'):
                $mng_content.html(overview);
                break;
            case('manager-upload-movie-link'):
            
                $mng_content.html(upload_movie);
                
                if(!framework.query.edit) {
                    
                    $("#inputFile").change(function() {
                        $("#inputFile").css('opacity','0.4');
                        var formData = new FormData($('#fileForm')[0]);
                        $.ajax({
                            url: "http://rentit.itu.dk/RentIt25/moofy.svc/movies/upload",
                            type: 'POST',
                            success: function(data) {
                                if(data.success) {
                                    $("#inputFile").hide();
                                    $("#fileForm .controls").append('<span id="tmpId">FILE_TMP_ID: '+data.tmpid+'</span>');
                                    tmp_id = data.tmpid;
                                }
                                else {
                                    alert("Fileupload failed (invalid file?)");
                                }
                                $("#inputFile").css('opacity','1');
                            },
                            error: function(data) {
                                alert("A server or connnection error was encountered while uploading the file. Fileupload failed.");
                                $("#inputFile").css('opacity','1');
                            },
                            data: formData,
                            contentType: false,
                            processData: false,
                            dataType: "json",
                        });
                    });
                    
                    $("#uploadMovie").submit(function() {
                        if(tmp_id <= 0) {
                            alert("Please upload a movie file before submitting the information!");
                            return false;
                        }
                        else {
                            var submitObject = {
                                managerid: framework.user.id,
                                tmpid: tmp_id,
                                title: $("#inputTitle").val(),
                                release: $("#inputRelease").val(),
                                directors: $("#inputDirectors").val().split(","),
                                genres: $("#inputGenres").val().split(","),
                                description: $("#inputDescription").val(),
                                rentalPrice: $("#inputRental").val(),
                                purchasePrice: $("#inputPurchase").val(),
                                coverUri: $("#inputCoverUri").val()
                            };
                            
                            $.ajax({
                                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/create',
                                type: 'POST',
                                data: JSON.stringify(submitObject),
                                contentType: "application/json",
                                dataType: "json",
                                success: function(data) {
                                    if(data.success) {
                                        alert("Movie created - thanks a bunch, brah. You will now be redirected to movie #"+data.id);
                                        framework.loadPage("movie",true,"movieId="+data.id);
                                    }
                                    else {
                                        alert("Failed to create movie somehow :(");
                                    }
                                },
                                error: function(data) {
                                    alert("Connection or server error!");
                                }
                            });
                            return false;
                        }
                    });
                    
                }
                    
                break;
            case('manager-upload-song-link'):
                $mng_content.html(upload_song);
                
                if(!framework.query.edit) {
                
                    $("#inputFile").change(function() {
                        $("#inputFile").css('opacity','0.4');
                        var formData = new FormData($('#fileForm')[0]);
                        $.ajax({
                            url: "http://rentit.itu.dk/RentIt25/moofy.svc/songs/upload",
                            type: 'POST',
                            success: function(data) {
                                if(data.success) {
                                    $("#inputFile").hide();
                                    $("#fileForm .controls").append('<span id="tmpId">FILE_TMP_ID: '+data.tmpid+'</span>');
                                    tmp_id = data.tmpid;
                                }
                                else {
                                    alert("Fileupload failed (invalid file?)");
                                }
                                $("#inputFile").css('opacity','1');
                            },
                            error: function(data) {
                                alert("A server or connnection error was encountered while uploading the file. Fileupload failed.");
                                $("#inputFile").css('opacity','1');
                            },
                            data: formData,
                            contentType: false,
                            processData: false,
                            dataType: "json",
                        });
                    });
                    
                    $("#uploadSong").submit(function() {
                        if(tmp_id <= 0) {
                            alert("Please upload a song file before submitting the information!");
                            return false;
                        }
                        else {
                            var submitObject = {
                                managerid: framework.user.id,
                                tmpid: tmp_id,
                                title: $("#inputTitle").val(),
                                artist: $("#inputArtist").val(),
                                album: $("#inputAlbum").val(),
                                release: $("#inputRelease").val(),
                                genres: $("#inputGenres").val().split(","),
                                description: $("#inputDescription").val(),
                                rentalPrice: $("#inputRental").val(),
                                purchasePrice: $("#inputPurchase").val(),
                                coverUri: $("#inputCoverUri").val()
                            };
                            
                            $.ajax({
                                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/create',
                                type: 'POST',
                                data: JSON.stringify(submitObject),
                                contentType: "application/json",
                                dataType: "json",
                                success: function(data) {
                                    if(data.success) {
                                        alert("Song created - thanks a bunch, brah. You will now be redirected to song #"+data.id);
                                        framework.loadPage("song",true,"songId="+data.id);
                                    }
                                    else {
                                        alert("Failed to create song somehow :(");
                                    }
                                },
                                error: function(data) {
                                    alert("Connection or server error!");
                                }
                            });
                            return false;
                        }
                    });
                    
                }
                
                break;
			case('manager-promote-link'):
				$mng_content.html(demote_promote);
				break;
        }
    });
    
    if(framework.query.edit) {
        if(!framework.query.id) {
            alert("No id set! Oopsie!");
        }
        else if(framework.query.edit == "movie") {
            $("#manager-upload-movie-link").click(); //load html
            
            //modify html for editing
            $("#fileForm").hide();
            $("legend").hide();
            $("#container h1").text("Edit movie");
            $("#manager-navigation").hide();
            $("#uploadMovieSubmit").text("Update information");
            
            //Load values
            $.ajax
            ({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/' + framework.query.id,
                type: 'GET',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                success: function(data) 
                {
                    $("#inputTitle").val(data.title);
                    $("#inputRelease").val(data.release);
                    $("#inputGenres").val(data.genres.join(","));
                    $("#inputDirectors").val(data.directors.join(","));
                    $("#inputRental").val(data.rentalPrice);
                    $("#inputPurchase").val(data.purchasePrice);
                    $("#inputCoverUri").val(data.coverUri);
                    $("#inputDescription").val(data.description);
                },
                error: function(msg)
                {
                    alert("Movie not found :(");
                    framework.loadPage("manager");
                }
            });
            
            $("#uploadMovie").submit(function() {
                //Get data
                var submitObject = {
                    managerid: framework.user.id,
                    title: $("#inputTitle").val(),
                    release: $("#inputRelease").val(),
                    directors: $("#inputDirectors").val().split(","),
                    genres: $("#inputGenres").val().split(","),
                    description: $("#inputDescription").val(),
                    rentalPrice: $("#inputRental").val(),
                    purchasePrice: $("#inputPurchase").val(),
                    coverUri: $("#inputCoverUri").val()
                };
                
                $("#uploadMovie").css('opacity',0.8);
                
                //Post it!
                $.ajax({
                    url: 'http://rentit.itu.dk/RentIt25/moofy.svc/movies/'+framework.query.id+'/update',
                    type: 'POST',
                    data: JSON.stringify(submitObject),
                    contentType: "application/json",
                    dataType: "json",
                    success: function(data) {
                        if(data.success) {
                            alert("Movie updated! Data saved.");
                        }
                        else {
                            alert("Failed to update movie somehow :(");
                        }
                        $("#uploadMovie").css('opacity',1);
                    },
                    error: function(data) {
                        alert("Connection or server error!");
                        $("#uploadMovie").css('opacity',1);
                    }
                });
                
                return false;
            });
        }
        else if(framework.query.edit == "song") {
            $("#manager-upload-song-link").click();
            
            //modify html for editing
            $("#fileForm").hide();
            $("legend").hide();
            $("#container h1").text("Edit song");
            $("#manager-navigation").hide();
            $("#uploadSongSubmit").text("Update information");
            
            //Load values
            $.ajax
            ({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/' + framework.query.id,
                type: 'GET',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                success: function(data) 
                {
                    $("#inputArtist").val(data.artists.join(","));
                    $("#inputTitle").val(data.title);
                    $("#inputAlbum").val(data.album);
                    $("#inputRelease").val(data.release);
                    $("#inputGenres").val(data.genres.join(","));
                    $("#inputRental").val(data.rentalPrice);
                    $("#inputPurchase").val(data.purchasePrice);
                    $("#inputCoverUri").val(data.coverUri);
                    $("#inputDescription").val(data.description);
                },
                error: function(msg)
                {
                    alert("Movie not found :(");
                    framework.loadPage("manager");
                }
            });
            
            $("#uploadSong").submit(function() {
                //Get data
                var submitObject = {
                    managerid: framework.user.id,
                    title: $("#inputTitle").val(),
                    artist: $("#inputArtist").val(),
                    album: $("#inputAlbum").val(),
                    release: $("#inputRelease").val(),
                    genres: $("#inputGenres").val().split(","),
                    description: $("#inputDescription").val(),
                    rentalPrice: $("#inputRental").val(),
                    purchasePrice: $("#inputPurchase").val(),
                    coverUri: $("#inputCoverUri").val()
                };
                
                $("#uploadSong").css('opacity',0.8);
                
                //Post it!
                $.ajax({
                    url: 'http://rentit.itu.dk/RentIt25/moofy.svc/songs/'+framework.query.id+'/update',
                    type: 'POST',
                    data: JSON.stringify(submitObject),
                    contentType: "application/json",
                    dataType: "json",
                    success: function(data) {
                        if(data.success) {
                            alert("Song updated! Data saved.");
                        }
                        else {
                            alert("Failed to update song somehow :(");
                        }
                        $("#uploadSong").css('opacity',1);
                    },
                    error: function(data) {
                        alert("Connection or server error!");
                        $("#uploadSong").css('opacity',1);
                    }
                });
                
                return false;
            });
        }
        else {
            $("#manager-overview-link").click();
            alert("Illegal value for edit paramenter...");
        }
    }
    else $("#manager-overview-link").click();
	
	function filterUsers(filter)
	{
		if(filter=="") 
		{
			var html = "";
			$.ajax({
                url: 'http://rentit.itu.dk/RentIt25/moofy.svc/users/filter',
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                success: function(usrs) {
				  
				  for(var i = 0; i<usrs.length; i++)
				  {
					var usr = usrs[i];
					var button = usr.admin ? "<button class='btn btn-primary'>Demote</button>" : "<button class='btn btn-primary'>Promote</button>";
					html+="<div id="+usr.id+">"+usr.name + button + "</br>";
				  }
                },
                error: function(msg) {
                    output.error("Error!","failed to connect to server, please try again");
                }
            });
			return html;
				
		}
		else return "lalalla";
	}
</script>


<!--<script src="manager-restriction.js"></script>-->